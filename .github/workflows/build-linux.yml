name: Build Linux

on:
  workflow_call:
    outputs:
      deb_path:
        description: "Path to built DEB file"
        value: ${{ jobs.build-linux.outputs.deb_path }}
      rpm_path:
        description: "Path to built RPM file"
        value: ${{ jobs.build-linux.outputs.rpm_path }}

jobs:
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      deb_path: ${{ steps.organize.outputs.deb_path }}
      rpm_path: ${{ steps.organize.outputs.rpm_path }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ¦‹ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: ðŸ“¦ Get dependencies
      run: flutter pub get

    - name: ðŸ”§ Install Linux build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libx11-dev pkg-config cmake ninja-build clang

    - name: ðŸ·ï¸ Get version
      id: get_version
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
        COMMIT_HASH=$(git rev-parse --short HEAD)
        VERSION_WITH_HASH="${VERSION}-${COMMIT_HASH}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_with_hash=$VERSION_WITH_HASH" >> $GITHUB_OUTPUT
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

    - name: âš’ï¸ Build Linux DEB
      run: flutter build linux --release

    - name: ðŸ“¦ Package Linux DEB
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg dpkg-dev
        cd build/linux/x64/release/bundle
        mkdir -p debian/DEBIAN
        mkdir -p debian/opt/my_flutter_app_0
        mkdir -p debian/usr/bin
        mkdir -p debian/usr/share/applications
        for file in *; do if [ "$file" != "debian" ]; then cp -r "$file" debian/opt/my_flutter_app_0/; fi; done
        ln -s /opt/my_flutter_app_0/my_flutter_app_0 debian/usr/bin/my_flutter_app_0
        cat > debian/DEBIAN/control << EOF
        Package: my-flutter-app-0
        Version: ${{ steps.get_version.outputs.version_with_hash }}
        Architecture: amd64
        Maintainer: Your Name <your.email@example.com>
        Description: My Flutter App 0
        EOF
        cat > debian/usr/share/applications/my-flutter-app-0.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=My Flutter App 0
        Exec=/usr/bin/my_flutter_app_0
        Icon=application-x-executable
        Categories=Utility;
        EOF
        dpkg-deb --build debian
        cd ../../../../..
        mkdir -p build/linux/outputs
        mv build/linux/x64/release/bundle/debian.deb build/linux/outputs/my_flutter_app_0-${{ steps.get_version.outputs.version_with_hash }}.deb

    - name: ðŸ“¦ Build Linux RPM
      run: |
        sudo apt-get install -y rpm
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

        # Create desktop file in temp location
        mkdir -p /tmp/rpm-files/usr/share/applications
        mkdir -p /tmp/rpm-files/usr/bin
        cat > /tmp/rpm-files/usr/share/applications/my-flutter-app-0.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=My Flutter App 0
        Exec=/usr/bin/my_flutter_app_0
        Icon=application-x-executable
        Categories=Utility;
        EOF

        cat > ~/rpmbuild/SPECS/my_flutter_app_0.spec << 'EOF'
        Name:           my-flutter-app-0
        Version:        ${{ steps.get_version.outputs.version }}
        Release:        ${{ github.run_number }}.${{ steps.get_version.outputs.commit_hash }}
        Summary:        My Flutter App 0
        License:        MIT

        %description
        My Flutter App 0

        %install
        mkdir -p %{buildroot}/opt/my_flutter_app_0
        mkdir -p %{buildroot}/usr/bin
        for file in /home/runner/work/my_flutter_app_0/my_flutter_app_0/build/linux/x64/release/bundle/*; do if [ "$(basename "$file")" != "debian" ]; then cp -r "$file" %{buildroot}/opt/my_flutter_app_0/; fi; done
        ln -s /opt/my_flutter_app_0/my_flutter_app_0 %{buildroot}/usr/bin/my_flutter_app_0
        install -D -m 644 /tmp/rpm-files/usr/share/applications/my-flutter-app-0.desktop %{buildroot}/usr/share/applications/my-flutter-app-0.desktop

        %files
        %defattr(-,root,root,-)
        /opt/my_flutter_app_0/*
        /usr/bin/my_flutter_app_0
        /usr/share/applications/my-flutter-app-0.desktop

        %post
        chmod +x /opt/my_flutter_app_0/my_flutter_app_0
        EOF

        rpmbuild -bb ~/rpmbuild/SPECS/my_flutter_app_0.spec
        mkdir -p build/linux/outputs
        cp ~/rpmbuild/RPMS/x86_64/*.rpm build/linux/outputs/my_flutter_app_0-${{ steps.get_version.outputs.version_with_hash }}.rpm || true

    - name: ðŸ“ Organize Linux outputs
      id: organize
      run: |
        APP_NAME_CLEAN=$(echo "${{ vars.APP_NAME }}" | tr ' ' '_')
        mkdir -p dist

        # DEB
        if [ -f build/linux/outputs/my_flutter_app_0-${{ steps.get_version.outputs.version_with_hash }}.deb ]; then
          cp build/linux/outputs/my_flutter_app_0-${{ steps.get_version.outputs.version_with_hash }}.deb dist/${APP_NAME_CLEAN}-${{ steps.get_version.outputs.version_with_hash }}.deb
          echo "deb_path=dist/${APP_NAME_CLEAN}-${{ steps.get_version.outputs.version_with_hash }}.deb" >> $GITHUB_OUTPUT
        fi

        # RPM
        if [ -f build/linux/outputs/my_flutter_app_0-${{ steps.get_version.outputs.version_with_hash }}.rpm ]; then
          cp build/linux/outputs/my_flutter_app_0-${{ steps.get_version.outputs.version_with_hash }}.rpm dist/${APP_NAME_CLEAN}-${{ steps.get_version.outputs.version_with_hash }}.rpm
          echo "rpm_path=dist/${APP_NAME_CLEAN}-${{ steps.get_version.outputs.version_with_hash }}.rpm" >> $GITHUB_OUTPUT
        fi

        ls -lh dist/

    - name: ðŸ“¤ Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-artifacts
        path: dist/
        retention-days: 1
