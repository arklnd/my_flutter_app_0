name: Build Windows

on:
  workflow_call:
    outputs:
      exe_path:
        description: "Path to built Windows bundle"
        value: ${{ jobs.build-windows.outputs.exe_path }}

jobs:
  build-windows:
    runs-on: windows-latest
    outputs:
      exe_path: ${{ steps.organize.outputs.exe_path }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ¦‹ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: ðŸ“¦ Get dependencies
      run: flutter pub get

    - name: ðŸ·ï¸ Get version
      id: get_version
      shell: bash
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
        COMMIT_HASH=$(git rev-parse --short HEAD)
        VERSION_WITH_HASH="${VERSION}-${COMMIT_HASH}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_with_hash=$VERSION_WITH_HASH" >> $GITHUB_OUTPUT

    - name: ðŸªŸ Build Windows EXE
      run: flutter build windows --release

    - name: ðŸ“ Organize Windows outputs
      id: organize
      shell: bash
      run: |
        APP_NAME_CLEAN=$(echo "${{ vars.APP_NAME }}" | tr ' ' '_')
        mkdir -p dist

        # Windows EXE - Create installer
        if [ -d build/windows/x64/runner/Release ]; then
          cd build/windows/x64/runner/Release
          7z a -r ../../../../../dist/${APP_NAME_CLEAN}-${{ steps.get_version.outputs.version_with_hash }}.zip .
          cd ../../../../../
          echo "exe_path=dist/${APP_NAME_CLEAN}-${{ steps.get_version.outputs.version_with_hash }}.zip" >> $GITHUB_OUTPUT
        fi

        ls -lh dist/

    - name: ðŸ“¤ Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: dist/
        retention-days: 1
